{% extends "base.html" %}
{% block title %}Crear Sprint{% endblock %}
{% block contenido %}
<div class="row">
    <div class="col-md-12">
        <div class="container">
            <h1>
                Creación de Sprint
            </h1>
        </div>
        <form id="sprintForm" action="">
            <div class="tab container">
                <h4>Información general del Sprint</h4>
                <div style="display: none;" class="alert alert-secondary" role="alert" id="aviso_dias_planeados_max">
                    Se recomienda que los días planeados no superen los {{proyecto.maximo_dias_sprint}} días.
                </div>
                <div style="display: none;" class="alert alert-secondary" role="alert" id="aviso_dias_planeados_min">
                    Se recomienda que los días planeados sean al menos {{proyecto.minimo_dias_sprint}} días.
                </div>
                <p><input type="text" placeholder="Nombre Sprint" required></p>
                <p><input type="textarea" placeholder="Descripción" required></p>
                <p>
                    <input type="number" id="input_dias_planeados" placeholder="Días planeados" required>
                </p>
            </div>
            
            <div class="tab container d-none">
                <h4>Historias de Usuario</h4>
                <div role="alert" class="alert alert-dark" id="aviso_horas_planeadas">
                    <span id="horas_total_planeadas">0</span> horas total
                </div>
                {% for historia in historias %}
                <div class="row ">
                    <div class="col-md-1 align-self-center d-flex justify-content-center">
                        <input type="checkbox" class="incluir_checkbox" name="historia_seleccionado_{{historia.id}}" value="{{historia.id}}">
                    </div>
                    <div class="col-md-11">
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="card shadow-sm" id="cd1">
                                    <div class="card-body p-2">
                                        <div class="card-title">
                                            <div>
                                                <label style="display: none;" for="historia_{{historia.id}}_horas" id="label_historia_horas_{{historia.id}}">Horas</label>
                                                <input style="display: none;" type="number" class="historia_horas_list" min="1" id="historia_horas_input_{{historia.id}}" name="historia_horas_{{historia.id}}" value="1">
                                            </div>
                                            <span class="lead font-weight-light fw-bold">{{ historia.id }}</span>
                                            <span class="lead font-weight-light">{{ historia.nombre }}</span>
                                            <br>
                                            <span class="badge bg-secondary">UP {{ historia.up }}</span>
                                            <span class="badge bg-secondary">BV {{ historia.bv }}</span>
                                            <br>
                                            <span>{{historia.fecha_modificacion|date:"Y/m/d"}}</span>
                                        </div>
                                        <div>
                                            <p>
                                                {{ historia.descripcion }}
                                            </p>
                                            <p>
                                                <select style="display: none;" class="form-control desarrollador_asignado_list" name="desarrollador_asignado_{{historia.id}}" id="desarrollador_asignado_{{historia.id}}">
                                                    <option value="">Usuario asignado:</option>
                                                    {% for desarrollador in proyecto.usuario.all %}
                                                    <option value="{{ desarrollador.id }}">
                                                        <img src="{{ desarrollador.avatar_url }}" alt="{{ desarrollador.get_full_name }} foto perfil" width="30" height="30"
                                                            class="rounded-circle" style="margin-right: 10px;" />
                                                        {{ desarrollador.get_full_name }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="tab container d-none">
                <h4>Horas desarolladores:</h4>
                {% for desarrollador in proyecto.usuario.all %}
                <div class="row desarrollador_horas_dia_list" id="campo_desarrollador_{{desarrollador.id}}">
                    <span id="aviso_horas_desarrollador_{{desarrollador.id}}">
                        Horas ingresadas difieren significativamente con horas calculadas de las historias de usuario!
                    </span>
                    <div class="col-md-4">
                        <img src="{{ desarrollador.avatar_url }}" alt="{{ desarrollador.get_full_name }} foto perfil" width="30" height="30"
                            class="rounded-circle" style="margin-right: 10px;" />
                        {{ desarrollador.get_full_name }}
                    </div>
                    <div class="col-md-4">
                        Horas según historias de usuario: <span class="horas_calculadas_desarrollador_list" id="horas_calculadas_{{desarrollador.id}}">0</span>
                        <br>
                        Horas según historias cantidad de días: <span id="horas_dias_{{desarrollador.id}}">0</span>
                    </div>
                    <div class="col-md-4">
                        Horas que trabaja por día:
                        <input type="number" min="0" max="24" value='0' class="horas_trabajadas_input" id="horas_trabajadas_{{desarrollador.id}}">
                    </div>
                </div>
                {% endfor %}
            </div>
            <br>
            <div class="container" style="overflow:auto;">
                <div style="float:left;">
                    <button type="button" id="prevBtn" onclick="nextPrev(-1)">Volver</button>
                    <button type="button" id="nextBtn" onclick="nextPrev(1)">Siguiente</button>
                </div>
            </div>
            
        </form>
    </div>
</div>

<script>
var tabActual = 0;
showTab(tabActual);

$('.incluir_checkbox').click( function() {
    var id = $(this).attr('name').replace('historia_seleccionado_', '');

    if($(this).is(':checked')) {
        $('#historia_horas_input_'+id).toggle();
        $('#label_historia_horas_'+id).toggle();
        $('#desarrollador_asignado_'+id).toggle();
    } else {
        $('#historia_horas_input_'+id).toggle();
        $('#label_historia_horas_'+id).toggle();
        $('#desarrollador_asignado_'+id).toggle();
    }
    $('.historia_horas_list').change();
})

$('#input_dias_planeados').mouseup(function(){
      $(this).change();
})
$('#input_dias_planeados').keyup(function(){
      $(this).change();
})
$('#input_dias_planeados').change(function () {
    var dias = $(this).val();
    if (dias > parseInt("{{proyecto.maximo_dias_sprint}}")) {
        $('#aviso_dias_planeados_max').show();
    } else {
        $('#aviso_dias_planeados_max').hide();
    }
    if (dias < parseInt("{{proyecto.minimo_dias_sprint}}")) {
        $('#aviso_dias_planeados_min').show();
    } else {
        $('#aviso_dias_planeados_min').hide();
    }

    if(dias < 0 || dias > 365) {
        $(this)[0].setCustomValidity("El número de días debe estar entre 0 y 365");
        valid = false;
    } else {
        $(this)[0].setCustomValidity("");
    }
})

$('.horas_trabajadas_input').mouseup(function(){
      $(this).change();
})
$('.horas_trabajadas_input').keyup(function(){
      $(this).change();
})
$('.horas_trabajadas_input').change(function () {
    var horas = $(this).val() * $('#input_dias_planeados').val();
    var id_dev = $(this).attr('id').replace('horas_trabajadas_', '');
    var horas_calculadas = $('#horas_calculadas_'+id_dev).text();

    $('#horas_dias_'+id_dev).text(horas);
    if (Math.abs((horas - horas_calculadas)) > Math.min(parseInt($(this).val()), parseInt($('#input_dias_planeados').val()))) {
        $('#aviso_horas_desarrollador_'+id_dev).show();
    } else {
        $('#aviso_horas_desarrollador_'+id_dev).hide();
    }
})

$('.historia_horas_list').mouseup(function(){
      $(this).change();
})
$('.historia_horas_list').keyup(function(){
      $(this).change();
})
$('.historia_horas_list').change(function () {
    horas = $('.historia_horas_list')

    $('#horas_total_planeadas').text(0)
    for(var i = 0; i < horas.length; i++) {
        if ($(horas[i]).is(":hidden")) {
            continue;
        }
        
        $("#horas_total_planeadas").text(parseInt($(horas[i]).val()) + parseInt($('#horas_total_planeadas').text()));
    }
})

function showTab(n) {
    var x = $(".tab");

    for (var i = 0; i < x.length; i++) {
        x[i].classList.add("d-none");
    }
    x[tabActual].classList.remove("d-none");
    x[tabActual].classList.add("d-block");

    // if (tabActual == 1) {
    //     $("#horas_total_asignadas").text($('#input_dias_planeados').val() * 8);
    // }

    if (n == 0) {
        document.getElementById("prevBtn").style.display = "none";
    } else {
        document.getElementById("prevBtn").style.display = "inline";
    }
    if (n == (x.length - 1)) {
        document.getElementById("nextBtn").innerHTML = "Crear";
    } else {
        document.getElementById("nextBtn").innerHTML = "Sgiuiente";
    }
}

function nextPrev(n) {
    var x = document.getElementsByClassName("tab");
    if (n == 1 && !validateForm()) return false;

    x[tabActual].style.display = "none";

    tabActual = tabActual + n;

    if (tabActual >= x.length) {
        document.getElementById("sprintForm").submit();
        return false;
    }

    if (tabActual == 2) {
        calcularHoras();
    }
    showTab(tabActual);
}

function calcularHoras() {
    var horas = $('.historia_horas_list')

    for (var i = 0; i < horas.length; i++) {
        var horas_calculadas = $('#horas_calculadas_' + horas[i].name.replace('historia_horas_', ''));
        horas_calculadas.text('0');
    }
    
    for(var i = 0; i < horas.length; i++) {
        if ($(horas[i]).is(":hidden")) {
            continue;
        }
        var horas_calculadas = $('#horas_calculadas_' + $('#desarrollador_asignado_' + horas[i].name.replace('historia_horas_', '')).find(":selected").val());
        horas_calculadas.text(parseInt(horas_calculadas.text()) + parseInt($(horas[i]).val()));
    }
}

function validateForm() {
    var valid = true;
    var input = $('.tab:first :input');
    
    if(tabActual == 0) {
        if(!input[0].checkValidity()) {
            valid = false;
        }
        if(!input[1].checkValidity()) {
            valid = false;
        }
        if(!input[2].checkValidity()) {
            valid = false;
        }
        $('#sprintForm')[0].reportValidity();
    }
    else if(tabActual == 1) {
        var horas = $('.historia_horas_list')
        for (var i = 0; i < horas.length; i++) {
            if ($(horas[i]).is(":hidden")) {
                continue;
            }
            if(!$(horas[i])[0].checkValidity()) {
                valid = false;
            }
        }

        var asignados = $('.desarrollador_asignado_list')
        for(var i = 0; i < asignados.length; i++) {
            if ($(asignados[i]).is(":hidden")) {
                $(asignados)[i].setCustomValidity("");
                continue;
            }
            if(!$(asignados[i]).val()) {
                $(asignados)[i].setCustomValidity("Debe asignar la historia a alguien");
                valid = false;
            } else {
                $(asignados)[i].setCustomValidity("");
            }
        }
        $('#sprintForm')[0].reportValidity();
    } else {
        return $('#sprintForm')[0].reportValidity();
    }

    return valid;
}
</script>
{% endblock %}
