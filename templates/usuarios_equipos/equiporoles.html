{% extends "base.html" %}
{% block contenido %}
{% load tiene_rol_en %}
{% obtener_proyecto proyecto_id as proyecto %}
{% tiene_rol_en_proyecto user "Scrum Master" proyecto.id as es_master %}

{% if es_master %}
    <div class="row mt-5">
        <div class="col-lg-6">
            {% if mensaje != '' %}
                <div class="alert alert-danger"><h6>{{ mensaje }}</h6></div>
            {% endif %}
        </div>
    </div>
    <div class="row mt-5">
        <div class="col-lg-12">
            <h3>Miembros de {{ proyecto.nombre }}</h3>
        </div>
    </div>
    <div class="row mt-2">
        <div class="col-lg-6">
            <form action="{% url 'vista_equipo' proyecto_id %}" method="POST">

                {% csrf_token %}
                <input name="proyecto" id="proyecto" hidden value="{{ proyecto.id }}">
                <input name="hidden_action" id="hidden_action" hidden value="agregar_miembro_proyecto">

                <label for="usuario_a_agregar">Agregar usuario: </label><input type="text" name="usuario_a_agregar" id="usuario_a_agregar" required="">
                <select name="roles_agregar" id="roles_agregar">
                    {% for rol in proyecto.proyecto_rol.all %}
                        <option value="{{ rol.id }}" name="rol" id="rol">{{ rol}}</option>
                    {% endfor %}
                </select>

            </div>
            <div class="col-lg-6">
                <button type="submit" class="btn btn-success">Agregar miembro al proyecto</button>
            </div>
            </form>
    </div>
    {% for miembros in proyecto.usuario.all %}
    {% obtener_rol_en_proyecto miembros proyecto.id as rolesActual %}
        <div class="row mt-2">
            <div class="col-lg-6">
                <form action="{% url 'vista_equipo' proyecto_id %}" method="POST">

                    {% csrf_token %}
                    <input name="hidden_action" id="hidden_action" hidden value="eliminar_miembro_proyecto">
                    <input name="usuario_a_eliminar" id="usuario_a_eliminar" hidden value="{{ miembros.email }}">
                    <input name="proyecto" id="proyecto" hidden value="{{ proyecto.id }}">

                    <p>{{ miembros.email }}</p>
                </div>
                <div class="col-lg-6">
                    <button type="submit" class="btn btn-danger">Eliminar Usuario</button>
                </div>
                </form>
        </div>
        <div class="row mt-2">
            <div class="col-lg-12">
                <h5>Roles:</h5>
            </div>
        </div>
        {% for r in rolesActual %}
            <div class="row mt-2">
                <div class="col-6">
                    <form action="{% url 'vista_equipo' proyecto_id %}" method="POST">

                        {% csrf_token %}
                        <input name="hidden_action" id="hidden_action" hidden value="eliminar_rol_proyecto">
                        <input name="usuario_a_sacar_rol" id="usuario_a_sacar_rol" hidden value="{{ miembros.email }}">
                        <input name="proyecto" id="proyecto" hidden value="{{ proyecto.id }}">
                        <input name="rol_id" id="rol_id" hidden value="{{ r.id }}">

                        {{ r.nombre }}
                        </div>
                        <div class="col-6">
                            <button type="submit" class="btn btn-warning">Desasignar rol</button>
                        </div>
                        </form>
                </div>
        {% endfor %}

        {% tiene_todos_los_roles miembros proyecto as tiene_todo %}
        {% if tiene_todo %}
        <div class="row mt-2">
            <div class="col-lg-6">
                <form action="{% url 'vista_equipo' proyecto_id %}" method="POST">

                    {% csrf_token %}
                    <input name="hidden_action" id="hidden_action" hidden value="asignar_rol_proyecto">
                    <input name="usuario_a_cambiar_rol" id="usuario_a_cambiar_rol" hidden value="{{ miembros.email }}">
                    <input name="proyecto" id="proyecto" hidden value="{{ proyecto.id }}">

                    <select name="roles{{ miembros.email }}" id="roles{{ miembros.email }}">
                        {% for rol in proyecto.proyecto_rol.all %}
                            {% if not rol in rolesActual %}
                                <option value="{{ rol.id }}" name="rol{{ rol.id }}" id="rol{{ rol.id }}">{{ rol }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div class="col-lg-6">
                    <button type="submit" class="btn btn-primary">Asignar Rol</button>
                </div>
                </form>
        </div>
        {% endif %}
    {% endfor %}
{% else %}
    {% for miembros in proyecto.usuario.all %}
    {% obtener_rol_en_proyecto miembros proyecto.id as rolesActual %}
        <div class="row mt-2">
            <div class="col-lg-12">
                <h4>{{ miembros.email }}</h4>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-lg-12">
                <h5>Roles:</h5>
            </div>
        </div>
        {% for r in rolesActual %}
            <div class="row mt-2">
                <div class="col-lg-12 offset-lg-2">
                    <p>{{ r }}</p>
                </div>
            </div>
        {% endfor %}
    {% endfor %}
{% endif %}

{% endblock %}