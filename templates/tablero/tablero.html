{% extends "base.html" %}
{% load static %}
{% block contenido %}
{% load tiene_rol_en %}
<div class="container-fluid pt-3 overflow-auto">
    <h3>{{ tipo.nombre }}</h3>
    <div class="small">{{ tipo.descripcion }}</div>
    <div class="row flex-row flex-sm-nowrap py-3">
        {% for etapa in etapas %}
        <div class="col-sm-6 col-md-4 col-xl-3">
            <div class="card bg-light">
                <div class="card-body">
                    <h6 class="card-title text-uppercase text-truncate py-2">{{ etapa.nombre }}{% if etapa.historias %} ({{etapa.historias.count}}){% endif %}</h6>
                    <div class="items border border-light">
                        {% for us in etapa.historias %}
                        <div class="card shadow-sm" id="cd1">
                            <div class="card-body p-2">
                                <div class="card-title">
                                    <span class="lead font-weight-light fw-bold">{{ us.id }}</span>
                                    <span class="lead font-weight-light">{{ us.nombre }}</span>
                                    <br>
                                    <span class="badge bg-secondary">UP {{ us.up }}</span>
                                    <span class="badge bg-secondary">BV {{ us.bv }}</span>
                                    <br>
                                    <span>{{us.fecha_modificacion|date:"Y/m/d"}}</span>
                                </div>
                                <div>
                                    <p>
                                        {{ us.descripcion }}
                                    </p>
                                    {% if us.usuarioAsignado %}
                                    <p>
                                        <img src="{{ us.usuarioAsignado.avatar_url }}" alt="{{ user.get_full_name }}" width="30" height="30"
                                            class="rounded-circle" style="margin-right: 10px;" />
                                        {{us.usuarioAsignado.get_full_name}}
                                    </p>
                                    <br>
                                    <div class="d-flex justify-content-evenly">
                                        {% tiene_permiso_en_proyecto user 'pro_modificarUS' us.proyecto as pro_modificarUS %}
                                        {% if pro_modificarUS %}
                                            <a href="{% url 'editar_historiaUsuario' us.proyecto.id us.id %}"><span 
                                            class="material-icons">create</span></a>
                                        {% endif %}
            
                                        {% tiene_permiso_en_proyecto user 'pro_cancelarUS' us.proyecto as pro_cancelarUS %}
                                        {% if pro_cancelarUS %}
                                            <a href="#modal{{ historia.id }}" data-bs-toggle="modal" data-bs-target="#modal{{ historia.id }}"><span class="material-icons">delete</span></a>
                                        {% endif %}
                                        <span>
                                            <a href="{% url 'comentarios_historiaUsuario' etapa.proyecto us.id %}"><span 
                                                class="material-icons">comment</span></a>
                                            {{ us.comentarios.count }}
                                        </span>
                                        <a href="{% url 'restaurar_historia_historial' etapa.proyecto us.id %}"><span 
                                            class="material-icons">history</span></a>
                                        {% tiene_rol_en_proyecto user 'Scrum Master' proyecto as master %}
                                        {% if master or us.usuarioAsignado == user %}
                                            <a href="#modalEtapa{{ historia.id }}" data-bs-toggle="modal" data-bs-target="#modalEtapa{{ historia.id }}"><span class="material-icons">arrow_forward</span></a>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    <p>
                                        <span class="fw-bold">Sin asignar</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="dropzone rounded"> &nbsp; </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
